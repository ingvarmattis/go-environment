name: Deploy to Home Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'go-environment'
        type: choice
        options:
        - go-environment
        - go-environment-staging
        - go-environment-test

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: go-environment
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        echo "Adding server ${{ vars.HOME_SERVER_IP }} to known hosts..."
        if [ -z "${{ vars.HOME_SERVER_IP }}" ]; then
          echo "Error: HOME_SERVER_IP is not set"
          exit 1
        fi
        
        # Get SSH host key from custom port 2222
        ssh-keyscan -H -p 2222 ${{ vars.HOME_SERVER_IP }} >> ~/.ssh/known_hosts
        

        
    - name: Deploy to Docker Swarm
      run: |
        # Deploy using the deployment script
        ssh -p 2222 ${{ vars.SSH_USER }}@${{ vars.HOME_SERVER_IP }} << 'EOF'
          # Create project directory if it doesn't exist
          sudo mkdir -p /home/go-environment
          sudo chown ${{ vars.SSH_USER }}:${{ vars.SSH_USER }} /home/go-environment
          
          # Go to project directory
          cd /home/go-environment
          
          # Create .env file with secrets
          cat > .env << ENVEOF
          GRAFANA_ADMIN_PASSWORD=${{ vars.GRAFANA_ADMIN_PASSWORD }}
          POSTGRES_PASSWORD=${{ vars.POSTGRES_PASSWORD }}
          POSTGRES_USER=${{ vars.POSTGRES_USER }}
          POSTGRES_DB=${{ vars.POSTGRES_DB }}
          GODADDY_DDNS_API_KEY=${{ vars.GODADDY_DDNS_API_KEY }}
          GODADDY_DDNS_API_SECRET=${{ vars.GODADDY_DDNS_API_SECRET }}
          GODADDY_DDNS_DOMAIN=${{ vars.GODADDY_DDNS_DOMAIN }}
          GODADDY_DDNS_INTERVAL=${{ vars.GODADDY_DDNS_INTERVAL }}
          ENVEOF
          
          # Clone repository if it doesn't exist
          if [ ! -d ".git" ]; then
            echo "Cloning repository..."
            # Remove existing content and clone fresh
            rm -rf * .git* 2>/dev/null || true
            git clone https://github.com/mattis.dev/go-environment.git .
          else
            echo "Updating code..."
            git pull origin main
          fi
          
          # Create necessary data directories
          sudo mkdir -p /data/fast/{prometheus_data,grafana_data,postgres_data,tempo_data,technitium-dns-data/zones,torrserver_data,torrserver_cache}
          sudo chown -R 1000:1000 /data/fast/
          
          # Make deployment script executable and run it
          chmod +x scripts/deploy-with-env.sh
          ./scripts/deploy-with-env.sh
          
          # Deploy Docker Swarm stack
          echo "ğŸš€ Deploying Docker Swarm stack..."
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“ Listing files:"
          ls -la
          echo "ğŸ“ Docker directory contents:"
          ls -la docker/
          echo "ğŸ“ Environment variables:"
          cat .env
          echo "ğŸ³ Docker Swarm status:"
          docker info | grep Swarm
          echo "ğŸš€ Starting deployment..."
          docker stack deploy --env-file .env -c docker/docker-swarm.yaml go-environment
          echo "âœ… Deployment completed"
          echo "ğŸ“Š Stack status:"
          docker stack ls
          echo "ğŸ“Š Services status:"
          docker stack services go-environment
        EOF
        
    - name: Health Check
      run: |
        ssh -p 2222 ${{ vars.SSH_USER }}@${{ vars.HOME_SERVER_IP }} << 'EOF'
          # Wait for services to start
          sleep 30
          
          # Check services status
          docker stack services ${{ github.event.inputs.environment || 'go-environment' }}
          
          # Check availability of main services
          echo "Checking service availability..."
          
          # Prometheus
          if curl -f http://localhost:9090/-/healthy; then
            echo "âœ… Prometheus is healthy"
          else
            echo "âŒ Prometheus health check failed"
            exit 1
          fi
          
          # Grafana
          if curl -f http://localhost:3000/api/health; then
            echo "âœ… Grafana is healthy"
          else
            echo "âŒ Grafana health check failed"
            exit 1
          fi
          
          echo "All services are healthy! ğŸ‰"
        EOF
